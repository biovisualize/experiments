<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title></title>
  <script type='text/javascript' src="../lib/d3.js"></script>
  <script type='text/javascript' src="plain_bar_chart.js"></script>
  <script type='text/javascript' src="container.js"></script>
  <style>
    body {
      font: 14px sans-serif;
    }
    .axis path, .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }
    .axis path{
      fill: none;
      stroke: black;
    }
    .bar {
      fill: steelblue;
    }
    svg{
      border: 1px solid silver;
    }
    svg rect{
      fill: aliceblue;
      stroke: grey;
    }
    path.domain{
      stroke: black;
      fill: none;
    }
    .tick line{
      stroke: black;
    }
    .tick text{
      font-size: 8px;
    }
  </style>
</head>
<body>

<!--<div id="container"></div>-->
<div id="container2"></div>

<script type="text/javascript">
  /*
    advantage of rewriting it from scratch:
    -generic faceting container
    -reusable charts
    -json spec decoupled from chart assembly
    -composition instead of hierarchy
    -decoupled from data format
    -testable (not just testing any output)
    -update/enter/exit
   */


  // data
  //////////////////////////////////////////////////////

  function shuffle(d){for(var c=d.length-1;c>0;c--){var b=Math.floor(Math.random()*(c+1));var a=d[c];d[c]=d[b];d[b]=a}return d};
  function pickRandom(arr){ return Math.floor(arr[~~(Math.random()*arr.length)]*100)/100; }
  function range(lower, upper){ return d3.range(upper-lower).map(function(d, i){ return d+lower; }); }
  function randomColor(){ return 'rgb('+~~(Math.random()*100+155)+','+~~(Math.random()*100+155)+','+~~(Math.random()*100+155)+')'; }
  var letters = d3.range(26).map(function(d, i){ return String.fromCharCode(d + 65); });
  var shuffleLetters = shuffle(letters);

  function generateDataset(){
    return d3.range(8).map(function(d, i){
      var rndLetter = shuffleLetters.pop(~~(Math.random()*(letters.length)));
      return {
        car: rndLetter,
        mpg: ~~(Math.random()*30 + 1),
        gear: ~~(Math.random()*3) + 1,
        wt: 1,
        cyl: pickRandom([4, 6, 8]),
        qsec: pickRandom(range(15, 25)),
        hp: pickRandom(range(90, 500)),
        am: pickRandom([0, 1]),
        vs: pickRandom([0, 1])
      };
    });
  }

  function getTextSize(text){
    var svg = d3.select('body').append('svg');
    var test = svg.node().appendChild(text).getBBox();
    console.log(svg.node(), test);
    svg.remove();
    return 0;
  }

  var data = [[0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 10, 11]];
//  var data = [[0, 1, 2, 3], [4, 5, 6, 7]];
  var svg = d3.select('#container2').append('svg');
  var showZones = false;


  // facets
  //////////////////////////////////////////////////////

  // chart space
  var w = 800, h = 500,
      titleSize = 50,
      chartSpaceX = titleSize,
      chartSpaceY = titleSize,
      chartSpaceW = w - titleSize * 2,
      chartSpaceH = h - titleSize * 2;
//  svg.append('rect').attr({x: chartSpaceX, y: chartSpaceY, width: chartSpaceW, height: chartSpaceH});

  var axisSize = 30,
      gridRowNum = data[0].length,
      gridColNum = data.length,
      facetW = (chartSpaceW - axisSize * 2)/gridRowNum,
      facetH = (chartSpaceH - axisSize * 2)/gridColNum;

  // titles
  //////////////////////////////////////////////////////

  var titles = svg.append('g').classed('titles', true);

  // y axis label
  var axisLabelY = titles.append('g').classed('axis-label-y', true)
      .attr({transform: 'translate('+[0, titleSize]+')'});
  axisLabelY.append('rect')
      .attr({width: titleSize, height: h - titleSize * 2})
      .style({visibility: showZones? 'visible' : 'hidden'});
  var text = axisLabelY.append('text')
      .text('test'); //hardcoded
  var textBBox = text.node().getBBox();
  text.attr({dy: textBBox.height})

  // chart title
  var chartTitle = titles.append('g').classed('chart-title', true)
      .attr({transform: 'translate('+[titleSize, 0]+')'});
  chartTitle.append('rect')
      .attr({width: w - titleSize * 2, height: titleSize})
      .style({visibility: showZones? 'visible' : 'hidden'});
  var text = chartTitle.append('text')
      .text('Chart Title') //hardcoded
  var textBBox = text.node().getBBox();
  text.attr({dy: textBBox.height / 2 + titleSize / 2, dx: (w - titleSize * 2 - textBBox.width) / 2});

  // legend
  var legend = titles.append('g').classed('legend', true)
      .attr({transform: 'translate('+[w - titleSize, titleSize]+')'});
  legend.append('rect')
      .attr({width: titleSize, height: h - titleSize * 2})
      .style({visibility: showZones? 'visible' : 'hidden'});
  var textBBox = text.node().getBBox();
  legend.append('text')
      .attr({dy: textBBox.height})
      .text('Legend');

  // x axis label
  var axisLabelX = titles.append('g').classed('axis-label-x', true)
      .attr({transform: 'translate('+[titleSize, h - titleSize]+')'});
  axisLabelX.append('rect')
      .attr({width: w - titleSize * 2, height: titleSize})
      .style({visibility: showZones? 'visible' : 'hidden'});
  var text = axisLabelX.append('text')
      .text('X Axis Label'); //hardcoded
  var textBBox = text.node().getBBox();
  text.attr({dy: textBBox.height / 2 + titleSize / 2, dx: (w - titleSize * 2 - textBBox.width) / 2});

  // facets
  //////////////////////////////////////////////////////

  var facetRow = svg.selectAll('g.facet-row')
      .data(data)
      .enter().append('g')
      .classed('facet-row', true);
  var facetGroup = facetRow.selectAll('g.facet-group')
      .data(function(d, i){ return d; })
      .enter().append('g')
      .classed('facet-group', true);

  // y axis
  var axisGroupY = facetGroup.filter(function(d, i){ return i == 0; }).append('g').classed('axis-group-y', true)
      .attr({transform: function(d, i, pI){ return 'translate('+[chartSpaceX, chartSpaceY + axisSize + facetH * pI]+')';}})
  axisGroupY.append('rect')
      .attr({
        width: axisSize,
        height: facetH
      })
      .style({visibility: showZones? 'visible' : 'hidden'});

  // y tab
  var tabGroupY = facetGroup.filter(function(d, i){ return i == data[0].length - 1; })
      .append('g').classed('tab-group-y', true)
      .attr({transform: function(d, i, pI){ return 'translate('+[chartSpaceX + axisSize + facetW * data[pI].length - 1, chartSpaceY + axisSize + facetH * pI]+')';}});
  tabGroupY.append('rect').classed('tab-y', true)
      .attr({
        width: axisSize,
        height: facetH
      });
  var text = tabGroupY.append('text')
      .text('test');
  var textBBox = text.node().getBBox();
      text.attr({dy: textBBox.height});

  // x tab
  var facetTabs = facetRow.filter(function(d, i){ return i == 0; }).selectAll('g.tab-group-x')
      .data(function(d, i){ return d; })
      .enter().append('g')
      .classed('tab-group-x', true)
      .attr({transform: function(d, i, pI){ return 'translate('+[chartSpaceX + axisSize + facetW * i, chartSpaceY + facetH * pI]+')';}});
  facetTabs.append('rect').classed('tab-rect-x', true)
      .attr({
        width: facetW,
        height: axisSize
      });
  var text = facetTabs.append('text').classed('tab-rect-x', true)
      .text('test') //hardcoded
  var textBBox = text.node().getBBox();
  text.attr({dy: textBBox.height, dx: (facetW - textBBox.width) / 2});

  // x axis
  var facetTabs = facetRow.filter(function(d, i){ return i == data.length - 1; }).selectAll('g.axis-group-x')
      .data(function(d, i){ return d; })
      .enter().append('g')
      .classed('axis-group-x', true)
      .attr({transform: function(d, i){ return 'translate('+[chartSpaceX + axisSize + facetW * i, chartSpaceY + axisSize + facetH * data.length]+')'; }});
  facetTabs.append('rect').classed('axis-x', true)
      .attr({
        width: facetW,
        height: axisSize
      })
      .style({visibility: showZones? 'visible' : 'hidden'});

  // chart
  //////////////////////////////////////////////////////
  facetGroup.append('g')
      .attr({
        'class': function(d, i, pI){ return 'chart_' + [i, pI].join('-'); },
        transform: function(d, i, pI){
          var x = chartSpaceX + axisSize + facetW * i;
          var y = chartSpaceY + axisSize + facetH * pI;
          return 'translate('+[x, y]+')';
        },
        width: facetW,
        height: facetH
      })
      .style({
        fill: 'skyblue'
      })
      .classed('chart', true);


  var dataY = [1, 2, 3, 4, 5, 6];
  var dataX = ['A', 'B', 'C', 'D', 'E', 'F'];

  var x1 = d3.scale.ordinal()
      .domain(dataX)
      .rangeRoundBands([0, facetW], .1);

  var y1 = d3.scale.linear()
      .domain([0, d3.max(dataY)])
      .range([facetH, 0]);

  var xAxis = d3.svg.axis()
      .scale(x1)
      .orient('bottom');

  var yAxis = d3.svg.axis()
      .scale(y1)
      .orient('left');

  svg.select('.x-axis-group.axis')
      .attr({transform: 'translate(0,' + (facetH) + ')'})
      .call(xAxis);

  svg.select('.y-axis-group.axis')
      .call(yAxis);

  d3.selectAll('.chart')
      .call(d3.custom.PlainBarChart().width(facetW).height(facetH));

  d3.selectAll('.axis-group-y')
      .each(function(d, i){
        d3.select(this).append('g')
            .attr({transform: 'translate('+axisSize+',0)'})
            .call(yAxis);
      });

  d3.selectAll('.axis-group-x')
      .each(function(d, i){
        d3.select(this).append('g')
            .call(xAxis);
      });



</script>

</body>
</html>